<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Fit Data | High Performance</title>
    <link rel="icon" href="favicon.ico">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        :root {
            --bg:#050505; --card:#121212; --input:#1f1f1f; --text:#fff; --dim:#888;
            --accent:#ff3333; --accent-dim:rgba(255,51,51,0.2); --accent-glow:0 0 12px rgba(255,51,51,0.5);
            --safe-top:env(safe-area-inset-top,20px); --safe-bottom:env(safe-area-inset-bottom,20px);
            --font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
        }
        *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
        body{background:var(--bg);color:var(--text);font-family:var(--font);height:100dvh;width:100vw;overflow:hidden;display:flex;flex-direction:column}
        .hidden{display:none!important}
        
        .btn{background:var(--accent);color:#fff;border:none;padding:14px;border-radius:8px;font-weight:800;text-transform:uppercase;cursor:pointer;width:100%;box-shadow:var(--accent-glow);display:flex;justify-content:center;align-items:center}
        .btn:active{transform:scale(.98)}
        .btn-outline{background:0 0;border:1px solid #444;color:#ccc;padding:12px;width:100%;border-radius:8px;font-weight:600;cursor:pointer;margin-top:10px;font-size:.85rem}
        .btn-small{padding:6px 12px;font-size:.75rem;width:auto;margin:0}
        .btn-danger{background:#600;border:1px solid #f00;color:#fcc;margin-top:15px}
        .btn-done{background:rgba(255,51,51,.3)!important;border:1px solid var(--accent)!important;color:#fff!important}

        #loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center}
        #loading-logo{width:140px;border-radius:25px;box-shadow:0 0 30px rgba(255,51,51,.3);animation:b 3s infinite;clip-path:inset(0 round 25px)}
        .loading-text{margin-top:30px;color:var(--accent);font-family:monospace;font-size:1.1rem;letter-spacing:4px;font-weight:bold;animation:bl .8s infinite}
        @keyframes b{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.8}} @keyframes bl{0%,100%{opacity:1}50%{opacity:.5}}

        header{flex-shrink:0;height:calc(60px + var(--safe-top));padding-top:var(--safe-top);background:rgba(5,5,5,.98);border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;padding-inline:20px;z-index:100}
        .brand{font-weight:900;font-size:1.3rem} .brand span{color:var(--accent)}
        .btn-neon{background:0 0;border:1px solid var(--accent);color:var(--accent);font-weight:800;padding:6px 12px;border-radius:4px;font-size:.75rem}

        #main-container{flex:1;overflow-y:auto;position:relative;scroll-behavior:smooth}
        .view-container{min-height:100%;padding:20px 15px 180px;display:none;opacity:0;animation:f .3s forwards}
        .view-container.active{display:block;opacity:1} @keyframes f{to{opacity:1}}

        .card{background:var(--card);border-radius:12px;padding:18px;margin-bottom:18px;border:1px solid #222}
        input,select,textarea{background:var(--input);border:1px solid #333;color:#fff;padding:12px;border-radius:8px;width:100%;margin-bottom:12px;font-size:16px;font-family:var(--font)}
        input:focus,textarea:focus{outline:1px solid var(--accent)}

        .profile-header{display:flex;align-items:center;gap:20px;margin-bottom:25px}
        .avatar-circle{width:75px;height:75px;border-radius:50%;background:#222;display:flex;justify-content:center;align-items:center;border:2px solid var(--accent);overflow:hidden}
        .avatar-circle img{width:100%;height:100%;object-fit:cover}

        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .stat-box{background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:10px;text-align:center}
        .stat-num{font-size:1.2rem;font-weight:800;display:block} .stat-label{font-size:.7rem;color:#888;text-transform:uppercase}

        .workout-split{display:grid;grid-template-columns:80px 1fr;gap:15px;margin-bottom:15px;align-items:center}
        .workout-visual{width:80px;height:80px;background:#000;border:1px solid #333;border-radius:8px;padding:5px;display:flex;justify-content:center;align-items:center}
        .workout-visual img{width:100%;height:100%;object-fit:contain}
        
        .muscle-bar-group{margin-bottom:8px} .muscle-label{display:flex;justify-content:space-between;font-size:.75rem;color:#ccc;margin-bottom:3px}
        .progress-track{width:100%;height:6px;background:#222;border-radius:3px;overflow:hidden} .progress-fill{height:100%;background:var(--accent);width:0%;transition:width 1s ease}
        
        .workout-bars{display:flex;flex-direction:column;gap:6px;width:100%}
        .mini-bar-label{font-size:.65rem;color:#888;display:flex;justify-content:space-between;margin-bottom:2px}
        .mini-track{width:100%;height:4px;background:#333;border-radius:2px;overflow:hidden} .mini-fill{height:100%;border-radius:2px;background:var(--accent)} .fill-sec{background:var(--warning)}

        .set-header{display:grid;grid-template-columns:25px 1fr 1fr 45px;gap:10px;font-size:.7rem;color:#666;margin-bottom:5px;text-align:center}
        .set-row{display:grid;grid-template-columns:25px 1fr 1fr 45px;gap:10px;align-items:center;margin-bottom:10px}
        .set-num{font-size:.85rem;color:#666;font-weight:bold;text-align:center} .shadow-val{display:block;font-size:.65rem;color:#555;text-align:center}

        .sticky-editor-header{position:sticky;top:-20px;background:var(--bg);z-index:50;padding:20px 0 10px;border-bottom:1px solid #222;margin:-20px 0 15px}
        .ex-select-item{display:flex;align-items:center;gap:15px;padding:12px;background:#1a1a1a;margin-bottom:6px;border-radius:8px;cursor:pointer;border:1px solid transparent}
        .ex-select-item img{width:45px;height:45px;object-fit:contain;background:#000;border:1px solid #333;border-radius:4px}
        .ex-select-item.selected{border-color:var(--accent);background:var(--accent-dim)}

        nav.bottom-nav{flex-shrink:0;height:calc(70px + var(--safe-bottom));padding-bottom:var(--safe-bottom);background:#0f0f0f;border-top:1px solid #222;display:flex;justify-content:space-around;z-index:999}
        .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#555;font-size:.65rem;cursor:pointer}
        .nav-item.active{color:var(--accent)} .nav-icon{font-size:1.5rem;margin-bottom:3px}

        .btn-float{position:fixed;bottom:100px;right:20px;width:60px;height:60px;border-radius:50%;background:var(--accent);color:#fff;display:grid;place-items:center;font-size:28px;box-shadow:0 5px 20px rgba(255,51,51,.6);z-index:1000;cursor:pointer}

        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:2000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none}
        .modal.active{opacity:1;pointer-events:auto}
        .modal-content{background:#1a1a1a;width:90%;max-width:400px;padding:25px;border-radius:15px;border:1px solid var(--accent);text-align:center;max-height:85vh;overflow-y:auto}

        .switch{position:relative;display:inline-block;width:46px;height:24px} .switch input{opacity:0;width:0;height:0}
        .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#333;transition:.4s;border-radius:34px}
        .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;transition:.4s;border-radius:50%}
        input:checked+.slider{background-color:var(--accent)} input:checked+.slider:before{transform:translateX(22px)}

        .compare-wrapper{position:relative;width:100%;height:250px;background:#000;border-radius:8px;overflow:hidden;margin-top:5px;border:1px solid #333}
        .compare-img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain}
        .img-overlay{clip-path:inset(0 50% 0 0);border-right:2px solid #fff}
        .slider-handle{position:absolute;top:0;bottom:0;left:50%;width:2px;cursor:ew-resize;z-index:10}
        .slider-btn{position:absolute;top:50%;left:-15px;width:30px;height:30px;background:#fff;border-radius:50%;display:grid;place-items:center;color:#000;box-shadow:0 0 10px #000}

        .photo-tabs{display:flex;margin-bottom:10px;background:#222;border-radius:8px;padding:2px}
        .photo-tab{flex:1;text-align:center;padding:10px;font-size:.8rem;cursor:pointer;color:#888;border-radius:6px}
        .photo-tab.active{background:var(--accent);color:#fff;font-weight:bold}
        .photo-actions{display:grid;grid-template-columns:1fr 40px 1fr 40px;gap:5px;margin-top:15px}
        
        .tip-box{background:rgba(255,170,0,.15);border:1px solid var(--warning);color:#ffcc80;padding:10px;border-radius:8px;font-size:.75rem;text-align:center;margin-bottom:15px}

        /* COACH & HISTORY */
        .admin-user-row{padding:15px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
        .coach-photos-row{display:flex;gap:10px;justify-content:center;margin-bottom:15px}
        .coach-photo-box{width:45%;height:150px;background:#000;border:1px solid #333;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative}
        .coach-photo-box img{width:100%;height:100%;object-fit:contain}
        .photo-date-label{position:absolute;bottom:0;left:0;width:100%;background:rgba(0,0,0,.7);font-size:.6rem;color:#fff;padding:2px 0;text-align:center}
        
        .assigned-routine-item{background:#222;padding:10px;margin-bottom:5px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;font-size:.8rem;border:1px solid #333}
        
        .history-row{display:grid;grid-template-columns:60px 1fr 20px 80px;border-bottom:1px solid #333;padding:10px 0;align-items:center;font-size:.75rem;text-align:left}
        .badge{padding:4px 8px;border-radius:4px;font-size:.65rem;font-weight:bold;text-transform:uppercase;text-align:center}
        .badge.green{background:rgba(46,125,50,.3);color:#a5d6a7;border:1px solid #2e7d32}
        .badge.orange{background:rgba(245,127,23,.3);color:#ffb74d;border:1px solid #f57f17}
        .badge.red{background:rgba(198,40,40,.3);color:#ef5350;border:1px solid #c62828}
        .badge.gray{background:#333;color:#aaa}
        
        .stat-pill-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center}
        .stat-pill{background:#111;border:1px solid #333;padding:8px 4px;border-radius:6px}
        .stat-pill b{display:block;font-size:1rem;color:var(--accent)} .stat-pill span{font-size:.65rem;color:#888;text-transform:uppercase}

        .rpe-btn{width:100%;margin-bottom:10px;border:none;padding:15px;border-radius:8px;color:#fff;font-weight:bold;text-transform:uppercase;cursor:pointer}
        .rpe-easy{background:#2e7d32} .rpe-hard{background:#f57f17;color:#000} .rpe-max{background:#c62828}
        
        .note-icon{cursor:pointer;font-size:1rem}
    </style>
</head>
<body>

    <div id="loading-screen">
        <img src="logo.png" id="loading-logo" onerror="this.style.display='none'">
        <div class="loading-text">SYSTEM INITIALIZED</div>
    </div>

    <header id="main-header" class="hidden">
        <div class="brand">FIT DATA <span>PRO</span></div>
        <button id="coach-btn" class="hidden btn-neon-text">COACH</button>
    </header>

    <main id="main-container">
        <section id="auth-view" class="view-container">
            <div style="text-align:center;margin:50px 0"><img src="logo.png" style="width:100px;border-radius:20px;clip-path:inset(0 round 20px)"><h1>ACCESO</h1></div>
            <div id="login-form">
                <input type="email" id="login-email" placeholder="Email"><input type="password" id="login-pass" placeholder="Contrase√±a">
                <button class="btn" id="btn-login">ENTRAR</button><button class="btn-outline" onclick="toggleAuth('register')">CREAR CUENTA</button>
            </div>
            <div id="register-form" class="hidden">
                <input type="text" id="reg-name" placeholder="Nombre"><input type="email" id="reg-email" placeholder="Email"><input type="password" id="reg-pass" placeholder="Contrase√±a">
                <div style="display:flex;gap:10px"><input type="number" id="reg-age" placeholder="Edad"><input type="number" id="reg-height" placeholder="Altura (cm)"></div>
                <input type="text" id="reg-code" placeholder="C√ìDIGO SECRETO">
                <button class="btn" id="btn-register">REGISTRARSE</button><button class="btn-outline" onclick="toggleAuth('login')">VOLVER</button>
            </div>
        </section>

        <section id="routines-view" class="view-container">
            <h2>MIS RUTINAS</h2><div id="routines-list"></div><button class="btn-float" onclick="openEditor()">+</button>
        </section>

        <section id="editor-view" class="view-container">
            <div class="sticky-editor-header">
                <h2 id="editor-title">NUEVA RUTINA</h2>
                <div style="display:flex;gap:10px"><input type="text" id="editor-name" placeholder="Nombre"><button class="btn" style="width:auto" onclick="saveRoutine()">GUARDAR</button></div>
                <input type="search" placeholder="üîç Buscar ejercicio..." oninput="filterExercises(this.value)" style="margin:0">
            </div>
            <div class="card" id="exercise-selector-list"></div><button class="btn-outline" onclick="switchTab('routines-view')">CANCELAR</button>
        </section>

        <section id="profile-view" class="view-container">
            <div class="profile-header">
                <div class="avatar-circle" onclick="document.getElementById('file-avatar').click()"><img id="avatar-img" src="" style="display:none"><span id="avatar-text">U</span></div>
                <input type="file" id="file-avatar" accept="image/*" class="hidden" onchange="uploadAvatar(this)">
                <div><h3 id="profile-name">Cargando...</h3><span style="color:#666;font-size:.8rem">Atleta</span></div>
            </div>
            <div class="card">
                <h3>ESTAD√çSTICAS</h3>
                <div class="stats-grid">
                    <div class="stat-box"><span class="stat-num" id="stat-workouts">0</span><span class="stat-label">Entrenos</span></div>
                    <div class="stat-box"><span class="stat-num" id="stat-kg">0</span><span class="stat-label">Kg Total</span></div>
                    <div class="stat-box"><span class="stat-num" id="stat-sets">0</span><span class="stat-label">Series</span></div>
                    <div class="stat-box"><span class="stat-num" id="stat-reps">0</span><span class="stat-label">Reps</span></div>
                </div>
            </div>
            <div class="card"><h3>MAPA MUSCULAR</h3><div id="heatmap-container"></div></div>
            <div class="card">
                <h3>EVOLUCI√ìN</h3>
                <div class="tip-box">üí° TIP: Usa siempre la misma luz, ropa y lugar.</div>
                <div class="photo-tabs"><div class="photo-tab active" id="tab-front" onclick="switchPose('front')">FRONTAL</div><div class="photo-tab" id="tab-back" onclick="switchPose('back')">ESPALDA</div></div>
                <div style="display:flex;justify-content:space-between;font-size:.7rem;color:#888;margin-bottom:5px"><span id="date-before">-</span><span id="date-after">-</span></div>
                <div class="compare-wrapper"><img src="" id="img-before" class="compare-img"><img src="" id="img-overlay" class="compare-img img-overlay"><div class="slider-handle" id="slider-handle"><div class="slider-btn">‚Üî</div></div></div>
                <input type="range" min="0" max="100" value="50" style="width:100%;margin-top:10px" oninput="moveSlider(this.value)">
                <div class="photo-actions">
                    <button class="btn-outline" style="margin:0" onclick="document.getElementById('f-before').click()">1. ANTES</button>
                    <button class="btn" style="background:#b71c1c;margin:0" onclick="deletePhoto('before')">üóëÔ∏è</button>
                    <button class="btn-outline" style="margin:0" onclick="document.getElementById('f-after').click()">2. AHORA</button>
                    <button class="btn" style="background:#b71c1c;margin:0" onclick="deletePhoto('after')">üóëÔ∏è</button>
                </div>
                <input type="file" id="f-before" class="hidden" accept="image/*" onchange="loadCompImg(this,'before')">
                <input type="file" id="f-after" class="hidden" accept="image/*" onchange="loadCompImg(this,'after')">
            </div>
            <div class="card">
                <h3>AJUSTES</h3>
                <div style="display:flex;gap:10px;margin-bottom:15px"><select id="photo-day" style="margin:0"><option value="1">Lunes</option><option value="5">Viernes</option></select><input type="time" id="photo-time" style="margin:0"><button class="btn-small btn" onclick="savePhotoReminder()">OK</button></div>
                <div style="display:flex;justify-content:space-between;margin-bottom:10px"><span>Sonido (5 Beeps)</span><div><button class="btn-small btn-outline" style="margin-right:10px" onclick="testSound()">PROBAR</button><label class="switch"><input type="checkbox" id="cfg-sound" checked><span class="slider"></span></label></div></div>
                <div style="display:flex;justify-content:space-between"><span>Pantalla Activa</span><label class="switch"><input type="checkbox" id="cfg-wake" checked><span class="slider"></span></label></div>
                <button class="btn-outline" onclick="saveConfig()">GUARDAR</button>
            </div>
            <div class="card">
                <h3>PESO CORPORAL</h3>
                <div style="position: relative; height: 200px; width: 100%;">
                    <canvas id="weightChart"></canvas>
                </div>
                <button class="btn-outline" onclick="addWeightEntry()">+ REGISTRAR HOY</button>
            </div>
            <button class="btn-outline" style="border-color:#500;color:#f55" onclick="logout()">CERRAR SESI√ìN</button>
        </section>

        <section id="workout-view" class="view-container">
            <div style="display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--bg);z-index:10;padding:10px 0;border-bottom:1px solid #222">
                <button onclick="switchTab('routines-view')" style="background:0;border:0;color:#666;font-size:1.5rem">‚úï</button>
                <div style="text-align:center"><span style="font-size:.6rem;color:#666">TIEMPO</span><br><span id="mini-timer" style="color:var(--accent);font-weight:bold">00:00</span></div>
                <button class="btn-small btn" onclick="promptRPE()">TERMINAR</button>
            </div>
            <h2 id="workout-title">Entreno</h2><div id="workout-exercises"></div>
        </section>

        <section id="admin-view" class="view-container"><h2>PANEL COACH</h2><div class="card"><h3>Atletas</h3><div id="admin-list"></div></div><button class="btn-outline" onclick="switchTab('routines-view')">VOLVER</button></section>
    </main>

    <nav class="bottom-nav hidden" id="bottom-nav">
        <div class="nav-item active" onclick="switchTab('routines-view')"><span class="nav-icon">üèãÔ∏è</span>Rutinas</div>
        <div class="nav-item" onclick="switchTab('profile-view')"><span class="nav-icon">‚öôÔ∏è</span>Perfil</div>
    </nav>

    <div id="modal-timer" class="modal"><div class="modal-content"><h3 style="color:var(--success-color)">DESCANSO</h3><div id="timer-display" style="font-size:5rem;font-weight:900;margin:20px 0">60</div><div style="display:flex;gap:15px;justify-content:center"><button class="btn-outline" onclick="addRestTime(20)">+20s</button><button class="btn" onclick="closeTimer()">OMITIR</button></div></div></div>
    
    <div id="modal-rpe" class="modal"><div class="modal-content">
        <h3>FINALIZAR</h3>
        <p style="color:#888;margin-bottom:15px">¬øDificultad?</p>
        <button class="rpe-btn rpe-easy" onclick="finishWorkout('Suave')">üü¢ SUAVE</button>
        <button class="rpe-btn rpe-hard" onclick="finishWorkout('Duro')">üü† DURO</button>
        <button class="rpe-btn rpe-max" onclick="finishWorkout('Fallo')">üî¥ FALLO</button>
        <textarea id="workout-notes" rows="3" placeholder="üìù Notas (opcional)..." style="width:100%; background:#222; border:1px solid #333; color:white; border-radius:8px; padding:10px; margin-top:10px;"></textarea>
        <button class="btn-outline" onclick="document.getElementById('modal-rpe').classList.remove('active')">CANCELAR</button>
    </div></div>

    <div id="modal-coach" class="modal"><div class="modal-content" style="text-align:left">
        <div style="text-align:center;margin-bottom:10px"><div class="avatar-circle" style="width:60px;height:60px;margin:0 auto 10px"><img id="coach-user-img" style="display:none"><span id="coach-user-initial">U</span></div><h3 id="coach-user-name">User</h3><p id="coach-user-email" style="color:#666;font-size:.8rem"></p></div>
        <div id="coach-stats-text" class="stat-pill-grid" style="margin-bottom:15px"></div>
        
        <h4>üì∏ Fotos</h4>
        <div class="photo-tabs"><div class="photo-tab active" id="coach-tab-front" onclick="switchCoachPose('front')">FRONTAL</div><div class="photo-tab" id="coach-tab-back" onclick="switchCoachPose('back')">ESPALDA</div></div>
        <div class="coach-photos-row" id="coach-photos-container"></div>

        <h4>Gr√°fica Peso</h4><div style="height:120px;margin-bottom:15px"><canvas id="coachWeightChart"></canvas></div>
        
        <h4>Rutinas Activas</h4><div id="coach-assigned-list" style="margin-bottom:15px;color:#888;font-size:.8rem"></div>
        
        <label style="font-size:.8rem;color:#ccc">Asignar:</label>
        <input type="text" placeholder="üîç Buscar rutina..." oninput="filterCoachRoutines(this.value)" style="width:100%;padding:8px;margin-bottom:5px;border-radius:6px;border:1px solid #333;background:#222;color:white">
        <div style="display:flex;gap:5px"><select id="coach-routine-select" style="margin:0"></select><button class="btn-small btn-outline" style="width:auto" onclick="goToCreateRoutine()">‚ûï</button><button class="btn-small btn" style="width:auto" onclick="assignRoutine()">OK</button></div>
        
        <div style="height:1px;background:#333;margin:15px 0"></div>
        <h4>Historial</h4><div id="coach-history-list" style="height:120px;overflow-y:auto;background:#000;padding:5px;border:1px solid #333;margin-bottom:15px"></div>
        
        <button class="btn" style="background:#600;border:1px solid #f00" onclick="deleteUser()">ELIMINAR ATLETA</button>
        <button class="btn-outline" onclick="document.getElementById('modal-coach').classList.remove('active')">CERRAR</button>
    </div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, where, addDoc, deleteDoc, getDocs, serverTimestamp, increment, orderBy, limit, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyCmM0gViU3itZ4HIZZVTEm7OaV0iBtsiGs",
            authDomain: "fitdata-7a86b.firebaseapp.com",
            projectId: "fitdata-7a86b",
            storageBucket: "fitdata-7a86b.firebasestorage.app",
            messagingSenderId: "949628013924",
            appId: "1:949628013924:web:86278ae2c2bafb384d7e71"
        });
        const auth = getAuth(app); const db = getFirestore(app);
        const ADMIN = "toni@fitdatapro.es"; const CODE = "fityhab";

        // AUDIO
        let audioCtx=null;
        function unlockAudio(){ if(!audioCtx){audioCtx=new(window.AudioContext||window.webkitAudioContext)()} if(audioCtx.state==='suspended')audioCtx.resume(); const b=audioCtx.createBuffer(1,1,22050); const s=audioCtx.createBufferSource(); s.buffer=b; s.connect(audioCtx.destination); s.start(0); }
        document.addEventListener('touchstart',unlockAudio,{once:true}); document.addEventListener('click',unlockAudio,{once:true});
        function play5Beeps(){ if(!audioCtx)unlockAudio(); if(audioCtx){ const now=audioCtx.currentTime; for(let i=0;i<5;i++){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.value=880; o.connect(g); g.connect(audioCtx.destination); o.start(now+(i*0.6)); o.stop(now+(i*0.6)+0.15); g.gain.setValueAtTime(0.5,now+(i*0.6)); g.gain.exponentialRampToValueAtTime(0.01,now+(i*0.6)+0.15); } } }
        window.testSound=play5Beeps;

        // DATA
        const EXERCISES=[
            {n:"Sentadilla con Barra", img:"cuadriceps.png", m:"Cu√°driceps"}, {n:"Sentadilla Jaca", img:"cuadriceps.png", m:"Cu√°driceps"},
            {n:"Sentadilla Cintur√≥n", img:"cuadriceps.png", m:"Cu√°driceps"}, {n:"Prensa de Piernas", img:"cuadriceps.png", m:"Cu√°driceps"},
            {n:"Extensi√≥n Cu√°driceps", img:"cuadriceps.png", m:"Cu√°driceps"}, {n:"Zancadas Mancuernas", img:"cuadriceps.png", m:"Cu√°driceps"},
            {n:"Curl Femoral Tumbado", img:"isquiotibiales.png", m:"Isquios"}, {n:"Curl Femoral Sentado", img:"isquiotibiales.png", m:"Isquios"},
            {n:"Prensa Horizontal", img:"cuadriceps.png", m:"Cu√°driceps"}, {n:"Prensa 45 Grados", img:"cuadriceps.png", m:"Cu√°driceps"},
            {n:"Gemelo Sentado", img:"gemelos.png", m:"Gemelos"}, {n:"Gemelo de Pie", img:"gemelos.png", m:"Gemelos"},
            {n:"Gemelo M√°quina", img:"gemelos.png", m:"Gemelos"}, {n:"Hip Thrust", img:"gluteos.png", m:"Gl√∫teos"},
            {n:"Sentadilla B√∫lgara", img:"gluteos.png", m:"Gl√∫teos"}, {n:"Patada Gl√∫teo Polea", img:"gluteos.png", m:"Gl√∫teos"},
            {n:"Abducci√≥n M√°quina", img:"gluteos.png", m:"Gl√∫teos"}, {n:"Prensa Gl√∫teos", img:"gluteos.png", m:"Gl√∫teos"},
            {n:"Peso Muerto Rumano", img:"isquiotibiales.png", m:"Isquios"},
            {n:"Peso Muerto", img:"espalda.png", m:"Espalda"}, {n:"Peso Muerto Sumo", img:"espalda.png", m:"Espalda"},
            {n:"Remo con Barra", img:"espalda.png", m:"Espalda"}, {n:"Remo Mancuernas", img:"espalda.png", m:"Espalda"},
            {n:"Jal√≥n al Pecho", img:"espalda.png", m:"Espalda"}, {n:"Jal√≥n Cerrado", img:"espalda.png", m:"Espalda"},
            {n:"Remo en M√°quina", img:"espalda.png", m:"Espalda"}, {n:"Remo Polea Baja", img:"espalda.png", m:"Espalda"},
            {n:"Dominadas", img:"espalda.png", m:"Espalda"}, {n:"Dominadas Asistidas", img:"espalda.png", m:"Espalda"},
            {n:"Remo Invertido", img:"espalda.png", m:"Espalda"}, {n:"Remo T", img:"espalda.png", m:"Espalda"},
            {n:"Hiperextensiones", img:"espalda.png", m:"Espalda"}, {n:"Buenos D√≠as", img:"isquiotibiales.png", m:"Isquios"},
            {n:"Remo Hammer", img:"espalda.png", m:"Espalda"}, {n:"Jal√≥n Neutro", img:"espalda.png", m:"Espalda"},
            {n:"Jal√≥n Abierto", img:"espalda.png", m:"Espalda"}, {n:"Remo al Cuello", img:"espalda.png", m:"Espalda"},
            {n:"Press Banca", img:"pecho.png", m:"Pecho"}, {n:"Press Inclinado Mancuernas", img:"pecho.png", m:"Pecho"},
            {n:"Aperturas Mancuernas", img:"pecho.png", m:"Pecho"}, {n:"Cruce de Poleas", img:"pecho.png", m:"Pecho"},
            {n:"Press M√°quina", img:"pecho.png", m:"Pecho"}, {n:"Press Declinado", img:"pecho.png", m:"Pecho"},
            {n:"Fondos", img:"triceps.png", m:"Tr√≠ceps"}, {n:"Contractora Pecho", img:"pecho.png", m:"Pecho"},
            {n:"Press Inclinado Barra", img:"pecho.png", m:"Pecho"}, {n:"Press Plano Mancuernas", img:"pecho.png", m:"Pecho"},
            {n:"Press Iso Lateral", img:"pecho.png", m:"Pecho"}, {n:"Press Vertical", img:"pecho.png", m:"Pecho"},
            {n:"Encogimientos Barra", img:"hombros.png", m:"Hombros"}, {n:"Encogimientos Mancuerna", img:"hombros.png", m:"Hombros"},
            {n:"Press Militar", img:"hombros.png", m:"Hombros"}, {n:"Press Hombro Mancuerna", img:"hombros.png", m:"Hombros"},
            {n:"Press Hombro M√°quina", img:"hombros.png", m:"Hombros"}, {n:"Elevaciones Laterales", img:"hombros.png", m:"Hombros"},
            {n:"Elevaciones Frontales", img:"hombros.png", m:"Hombros"}, {n:"P√°jaros", img:"hombros.png", m:"Hombros"},
            {n:"Laterales Polea", img:"hombros.png", m:"Hombros"}, {n:"Press Arnold", img:"hombros.png", m:"Hombros"},
            {n:"Press Trasnuca", img:"hombros.png", m:"Hombros"}, {n:"Face Pull", img:"hombros.png", m:"Hombros"},
            {n:"Curl Barra", img:"biceps.png", m:"B√≠ceps"}, {n:"Curl Mancuernas", img:"biceps.png", m:"B√≠ceps"},
            {n:"Curl Polea", img:"biceps.png", m:"B√≠ceps"}, {n:"Curl Martillo", img:"biceps.png", m:"B√≠ceps"},
            {n:"Curl Concentrado", img:"biceps.png", m:"B√≠ceps"}, {n:"Curl Predicador", img:"biceps.png", m:"B√≠ceps"},
            {n:"Extensi√≥n Polea", img:"triceps.png", m:"Tr√≠ceps"}, {n:"Press Franc√©s", img:"triceps.png", m:"Tr√≠ceps"},
            {n:"Rompecr√°neos", img:"triceps.png", m:"Tr√≠ceps"}, {n:"Fondos Tr√≠ceps", img:"triceps.png", m:"Tr√≠ceps"},
            {n:"Extensi√≥n Unilateral", img:"triceps.png", m:"Tr√≠ceps"}, {n:"Patada Tr√≠ceps", img:"triceps.png", m:"Tr√≠ceps"},
            {n:"Copa Tr√≠ceps", img:"triceps.png", m:"Tr√≠ceps"},
            {n:"Rueda Abdominal", img:"abs.png", m:"Abs"}, {n:"Crunch Polea", img:"abs.png", m:"Abs"},
            {n:"Elevaci√≥n Piernas", img:"abs.png", m:"Abs"}, {n:"Abdominales Banco", img:"abs.png", m:"Abs"},
            {n:"Crunch M√°quina", img:"abs.png", m:"Abs"}, {n:"Rodillas al Pecho", img:"abs.png", m:"Abs"}
        ];
        
        let currentUser=null, userData=null, activeWorkout=null, timerInt=null, restTimeRemaining=0, wakeLock=null, chartInstance=null, selectedUserCoach=null, selectedUserObj=null, editingRoutineId=null, coachChart=null, currentPose='front', coachCurrentPose='front', allRoutinesCache=[];

        function getExerciseData(name) { 
            let m=EXERCISES.find(e=>e.n===name); 
            if(!m){ 
                if(name.toLowerCase().includes("press")||name.toLowerCase().includes("pecho")) return {img:"pecho.png", mInfo:{main:"Pecho",sec:["Tr√≠ceps"]}};
                if(name.toLowerCase().includes("remo")||name.toLowerCase().includes("espalda")) return {img:"espalda.png", mInfo:{main:"Espalda",sec:["B√≠ceps"]}};
                if(name.toLowerCase().includes("sentadilla")||name.toLowerCase().includes("pierna")) return {img:"cuadriceps.png", mInfo:{main:"Cu√°driceps",sec:["Gl√∫teos"]}};
                if(name.toLowerCase().includes("curl")||name.toLowerCase().includes("biceps")) return {img:"biceps.png", mInfo:{main:"B√≠ceps",sec:["Antebrazo"]}};
                if(name.toLowerCase().includes("triceps")||name.toLowerCase().includes("frances")) return {img:"triceps.png", mInfo:{main:"Tr√≠ceps",sec:["Pecho"]}};
                if(name.toLowerCase().includes("hombro")||name.toLowerCase().includes("militar")) return {img:"hombros.png", mInfo:{main:"Hombros",sec:["Tr√≠ceps"]}};
                return {img:"logo.png", mInfo:{main:"General",sec:[]}} 
            } 
            let sec=[]; 
            if(m.m==="Pecho") sec=["Tr√≠ceps","Hombros"]; else if(m.m==="Espalda") sec=["B√≠ceps"]; 
            else if(m.m==="Cu√°driceps") sec=["Gl√∫teos"]; else if(m.m==="Isquios") sec=["Gl√∫teos"];
            else if(m.m==="Hombros") sec=["Tr√≠ceps"]; else if(m.m==="B√≠ceps") sec=["Antebrazo"];
            else if(m.m==="Tr√≠ceps") sec=["Pecho"];
            return {img:m.img, mInfo:{main:m.m,sec:sec}}; 
        }

        onAuthStateChanged(auth, async(u)=>{
            if(u){
                currentUser=u; const s=await getDoc(doc(db,"users",u.uid));
                if(s.exists()){
                    userData=s.data();
                    if(userData.email===ADMIN) { document.getElementById('coach-btn').classList.remove('hidden'); document.getElementById('coach-btn').onclick=()=>{loadAdminUsers();switchTab('admin-view')}; }
                    if(userData.approved){ document.getElementById('loading-screen').classList.add('hidden'); document.getElementById('main-header').classList.remove('hidden'); document.getElementById('bottom-nav').classList.remove('hidden'); loadRoutines(); switchTab('routines-view'); loadProfile(); } 
                    else { alert("Cuenta en revisi√≥n"); signOut(auth); }
                }
            } else { document.getElementById('loading-screen').classList.add('hidden'); switchTab('auth-view'); document.getElementById('main-header').classList.add('hidden'); document.getElementById('bottom-nav').classList.add('hidden'); }
        });

        window.switchTab=(t)=>{ document.querySelectorAll('.view-container').forEach(e=>e.classList.remove('active')); document.getElementById(t).classList.add('active'); if(t==='profile-view')loadProfile(); };
        window.toggleAuth=(m)=>{ document.getElementById('login-form').classList.toggle('hidden',m!=='login'); document.getElementById('register-form').classList.toggle('hidden',m!=='register'); };
        window.logout=()=>signOut(auth).then(()=>location.reload());

        // ROUTINES
        async function loadRoutines(){
            const l=document.getElementById('routines-list'); l.innerHTML='Cargando...';
            onSnapshot(query(collection(db,"routines")),(s)=>{
                l.innerHTML='';
                s.forEach(d=>{
                    const r=d.data();
                    if(r.uid===currentUser.uid || (r.assignedTo && r.assignedTo.includes(currentUser.uid))){
                        const div=document.createElement('div'); div.className='card';
                        div.innerHTML=`<div style="display:flex;justify-content:space-between"><h3>${r.name}</h3>${r.uid===currentUser.uid?`<button style="background:0;border:0" onclick="openEditor('${d.id}')">‚úèÔ∏è</button>`:''}</div><button class="btn" onclick="startWorkout('${d.id}')">ENTRENAR</button>`;
                        l.appendChild(div);
                    }
                });
            });
        }

        window.openEditor=async(id=null)=>{ editingRoutineId=id; document.getElementById('editor-name').value=''; renderExercises(EXERCISES); if(id){const s=await getDoc(doc(db,"routines",id));document.getElementById('editor-name').value=s.data().name} switchTab('editor-view'); };
        window.saveRoutine=async()=>{ const n=document.getElementById('editor-name').value; const s=Array.from(document.querySelectorAll('.ex-select-item.selected')).map(e=>e.innerText); if(!n||s.length===0)return alert("Datos?"); const d={uid:currentUser.uid,name:n,exercises:s,createdAt:serverTimestamp()}; if(editingRoutineId)await updateDoc(doc(db,"routines",editingRoutineId),d); else await addDoc(collection(db,"routines"),d); switchTab('routines-view'); };
        window.renderExercises=(l)=>{ const c=document.getElementById('exercise-selector-list'); c.innerHTML=''; l.forEach(e=>{const d=document.createElement('div');d.className='ex-select-item';d.innerHTML=`<img src="${e.img}" onerror="this.src='logo.png'"><span>${e.n}</span>`;d.onclick=()=>d.classList.toggle('selected');c.appendChild(d)}) };
        window.filterExercises=(v)=>renderExercises(EXERCISES.filter(e=>e.n.toLowerCase().includes(v.toLowerCase())));

        // WORKOUT
        window.startWorkout=async(rid)=>{
            if(document.getElementById('cfg-wake').checked && 'wakeLock' in navigator) try{wakeLock=await navigator.wakeLock.request('screen')}catch(e){}
            const snap=await getDoc(doc(db,"routines",rid)); const r=snap.data();
            activeWorkout={name:r.name,exs:r.exercises.map(n=>{
                const d = getExerciseData(n);
                return {n:n, img:d.img, mInfo:d.mInfo, sets:[{r:12,w:0,d:false},{r:12,w:0,d:false},{r:12,w:0,d:false}]}
            })};
            renderWorkout(); switchTab('workout-view');
        };
        function renderWorkout(){
            const c=document.getElementById('workout-exercises'); c.innerHTML='';
            activeWorkout.exs.forEach((e,i)=>{
                let bars = `<div class="mini-bar-label"><span>${e.mInfo.main}</span><span>100%</span></div><div class="mini-track"><div class="mini-fill" style="width:100%"></div></div>`;
                let h=`<div class="card" style="border-left:3px solid var(--accent-color)">
                <div class="workout-split"><div class="workout-visual"><img src="${e.img}"></div><div class="workout-bars" style="width:100%">${bars}</div></div>
                <h3>${e.n}</h3>`;
                e.sets.forEach((s,j)=>{ h+=`<div class="set-row"><div class="set-num">${j+1}</div><input type="number" value="${s.r}" onchange="activeWorkout.exs[${i}].sets[${j}].r=this.value"><input type="number" value="${s.w}" onchange="activeWorkout.exs[${i}].sets[${j}].w=this.value"><button class="btn-outline ${s.d?'btn-done':''}" onclick="toggleSet(${i},${j})">${s.d?'‚úì':''}</button></div>`; });
                c.innerHTML+=h+'</div>';
            });
        }
        window.toggleSet=(i,j)=>{ activeWorkout.exs[i].sets[j].d=!activeWorkout.exs[i].sets[j].d; renderWorkout(); if(activeWorkout.exs[i].sets[j].d)openRest(); };
        function openRest(){ const m=document.getElementById('modal-timer'); m.classList.add('active'); restTimeRemaining=userData.restTime||60; document.getElementById('timer-display').innerText=restTimeRemaining; if(timerInt)clearInterval(timerInt); timerInt=setInterval(()=>{ restTimeRemaining--; document.getElementById('timer-display').innerText=restTimeRemaining; if(restTimeRemaining<=0){ clearInterval(timerInt); m.classList.remove('active'); if(document.getElementById('cfg-sound').checked)play5Beeps(); } },1000); }
        window.addRestTime=(s)=>{restTimeRemaining+=s;document.getElementById('timer-display').innerText=restTimeRemaining};
        window.closeTimer=()=>{clearInterval(timerInt);document.getElementById('modal-timer').classList.remove('active')};
        window.promptRPE=()=>document.getElementById('modal-rpe').classList.add('active');
        
        window.finishWorkout=async(rpe)=>{
            document.getElementById('modal-rpe').classList.remove('active');
            const note = document.getElementById('workout-notes').value; 
            let s=0,r=0,k=0; let mc={}; let prAlert = ""; 
            if(!userData.prs) userData.prs = {};
            activeWorkout.exs.forEach(e=>e.sets.forEach(st=>{
                if(st.d){ s++;r+=parseInt(st.r)||0; 
                    const weight = parseInt(st.w)||0;
                    k+=weight*(parseInt(st.r)||0); 
                    mc[e.mInfo.main]=(mc[e.mInfo.main]||0)+1; 
                    if(weight > (userData.prs[e.n] || 0)) { userData.prs[e.n] = weight; prAlert = `üèÜ R√âCORD: ${e.n} (${weight}kg)\n`; }
                }
            }));
            if(prAlert) alert(prAlert); 
            await addDoc(collection(db,"workouts"),{uid:currentUser.uid,date:serverTimestamp(),routine:activeWorkout.name,rpe:rpe,note:note});
            let up={"stats.workouts":increment(1),"stats.totalSets":increment(s),"stats.totalReps":increment(r),"stats.totalKg":increment(k),"prs": userData.prs};
            for(const [m,c] of Object.entries(mc)) up[`muscleStats.${m}`]=increment(c);
            await updateDoc(doc(db,"users",currentUser.uid),up);
            if(wakeLock)wakeLock.release(); switchTab('routines-view');
        };

        // PROFILE & PHOTOS
        async function loadProfile(){
            document.getElementById('profile-name').innerText=userData.name;
            if(userData.photo) document.getElementById('avatar-img').src=userData.photo;
            updatePhotoDisplay(userData);
            if(userData.restTime) document.getElementById('cfg-rest-time').value = userData.restTime;
            if(userData.stats){ document.getElementById('stat-workouts').innerText=userData.stats.workouts||0; document.getElementById('stat-kg').innerText=((userData.stats.totalKg||0)/1000).toFixed(1)+'t'; document.getElementById('stat-sets').innerText=userData.stats.totalSets||0; document.getElementById('stat-reps').innerText=userData.stats.totalReps||0; }
            
            const muscles = ["Pecho","Espalda","Cu√°driceps","Isquios","Gl√∫teos","Hombros","B√≠ceps","Tr√≠ceps"];
            const hC = document.getElementById('heatmap-container'); hC.innerHTML = '';
            const mS = userData.muscleStats || {};
            muscles.forEach(m=>{
                const c = mS[m] || 0; const pct = Math.min((c/20)*100,100);
                hC.innerHTML+=`<div class="muscle-bar-group"><div class="muscle-label"><span>${m}</span><span>${c} s</span></div><div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div></div>`;
            });

            // CHART FIX FOR EMPTY DATA
            const ctx = document.getElementById('weightChart'); 
            if(chartInstance) chartInstance.destroy();
            const rawData = userData.weightHistory;
            const data = (rawData && rawData.length > 0) ? rawData : [70]; 
            
            chartInstance = new Chart(ctx, { type:'line', data:{ labels:data.map((_,i)=>`T${i}`), datasets:[{label:'Kg', data:data, borderColor:'#ff3333', backgroundColor:'rgba(255,51,51,0.1)', fill:true, tension:0.4}] }, options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{grid:{color:'#333'}}},maintainAspectRatio:false} });
        }
        
        window.switchPose=(p)=>{ currentPose=p; document.getElementById('tab-front').classList.toggle('active',p==='front'); document.getElementById('tab-back').classList.toggle('active',p==='back'); updatePhotoDisplay(userData); };
        function updatePhotoDisplay(u){
            const pre=currentPose==='front'?'':'_back';
            document.getElementById('img-before').src=u[`photoBefore${pre}`]||'';
            document.getElementById('img-overlay').src=u[`photoAfter${pre}`]||'';
            document.getElementById('date-before').innerText = `ANTES (${u[`dateBefore${pre}`]||'-'})`;
            document.getElementById('date-after').innerText = `AHORA (${u[`dateAfter${pre}`]||'-'})`;
        }
        window.loadCompImg=(inp,t)=>{
            if(inp.files[0]){
                const r=new FileReader();
                r.onload=(e)=>{
                    const img=new Image(); img.src=e.target.result;
                    img.onload=async()=>{
                        const c=document.createElement('canvas'); const ctx=c.getContext('2d');
                        const sc=600/img.width; c.width=600; c.height=img.height*sc;
                        ctx.drawImage(img,0,0,c.width,c.height);
                        const d=c.toDataURL('image/jpeg',0.7); const pre=currentPose==='front'?'':'_back';
                        const today=new Date().toLocaleDateString();
                        let up={}; up[`photo${t==='before'?'Before':'After'}${pre}`]=d; up[`date${t==='before'?'Before':'After'}${pre}`]=today;
                        await updateDoc(doc(db,"users",currentUser.uid),up);
                        userData[`photo${t==='before'?'Before':'After'}${pre}`]=d; userData[`date${t==='before'?'Before':'After'}${pre}`]=today; updatePhotoDisplay(userData);
                    }
                }; r.readAsDataURL(inp.files[0]);
            }
        };
        window.deletePhoto=async(t)=>{
            if(!confirm("¬øBorrar foto?"))return;
            const pre=currentPose==='front'?'':'_back';
            let up={}; up[`photo${t==='before'?'Before':'After'}${pre}`]=""; up[`date${t==='before'?'Before':'After'}${pre}`]="";
            await updateDoc(doc(db,"users",currentUser.uid),up);
            userData[`photo${t==='before'?'Before':'After'}${pre}`]=""; updatePhotoDisplay(userData);
        };
        window.moveSlider=(v)=>{document.getElementById('img-overlay').style.clipPath=`inset(0 ${100-v}% 0 0)`;document.getElementById('slider-handle').style.left=`${v}%`};
        window.saveConfig=async()=>{ await updateDoc(doc(db,"users",currentUser.uid),{restTime:parseInt(document.getElementById('cfg-rest-time').value)}); alert("Guardado"); };
        window.savePhotoReminder=async()=>{ await updateDoc(doc(db,"users",currentUser.uid),{photoDay:document.getElementById('photo-day').value,photoTime:document.getElementById('photo-time').value}); alert("Alarma OK"); };
        
        // FIXED WEIGHT ENTRY
        window.addWeightEntry=async()=>{ 
            const wStr = prompt("Introduce tu peso (kg):");
            if(!wStr) return;
            const w = parseFloat(wStr.replace(',','.'));
            if(isNaN(w)) return alert("N√∫mero inv√°lido");
            let h = userData.weightHistory || []; h.push(w);
            try {
                await updateDoc(doc(db,"users",currentUser.uid),{weightHistory:h});
                userData.weightHistory=h; loadProfile(); alert("‚úÖ Peso Guardado");
            } catch(e) { alert("Error al guardar: " + e.message); }
        };

        // COACH
        async function loadAdminUsers(){
            const l=document.getElementById('admin-list'); l.innerHTML='';
            const s=await getDocs(collection(db,"users"));
            s.forEach(d=>{
                const u=d.data(); if(u.email===ADMIN)return;
                const div=document.createElement('div'); div.className='admin-user-row';
                div.innerHTML=`<div><strong>${u.name}</strong><br><small>${u.approved?'üü¢':'‚è≥'} ${u.email}</small></div><button class="btn-outline btn-small" style="width:auto">VER FICHA</button>`;
                div.onclick=()=>openCoachModal(d.id,u); l.appendChild(div);
            });
        }
        async function openCoachModal(uid,u_old){
            const freshSnap = await getDoc(doc(db, "users", uid));
            const u = freshSnap.data();
            selectedUserObj = u; selectedUserCoach = uid;
            document.getElementById('modal-coach').classList.add('active');
            document.getElementById('coach-user-name').innerText=u.name;
            document.getElementById('coach-user-email').innerText=u.email;
            
            const img=document.getElementById('coach-user-img'); const ini=document.getElementById('coach-user-initial');
            if(u.photo){img.src=u.photo;img.style.display='block';ini.style.display='none'}else{img.style.display='none';ini.style.display='block'}
            const st=u.stats||{}; const age=u.age||'N/A';
            document.getElementById('coach-stats-text').innerHTML=`<div class="stat-pill"><b>${st.workouts||0}</b><span>WO</span></div><div class="stat-pill"><b>${(st.totalKg/1000||0).toFixed(1)}t</b><span>KG</span></div><div class="stat-pill"><b>${age}</b><span>EDAD</span></div>`;
            
            updateCoachPhotoDisplay('front');

            try {
                const s = document.getElementById('coach-routine-select'); s.innerHTML = '';
                const rS = await getDocs(collection(db,"routines")); 
                allRoutinesCache = [];
                rS.forEach(r => {
                    const data = r.data();
                    allRoutinesCache.push({id: r.id, ...data});
                    const o = document.createElement('option'); o.value = r.id; o.innerText = data.name; s.appendChild(o); 
                });
            } catch(e) { console.error("Error loading routines for dropdown", e); }

            try {
                const aList=document.getElementById('coach-assigned-list'); aList.innerHTML='Cargando...';
                const qA=query(collection(db,"routines"),where("assignedTo","array-contains",uid));
                const sA=await getDocs(qA); aList.innerHTML=''; 
                if(sA.empty)aList.innerHTML='Sin rutinas.';
                sA.forEach(r=>{ aList.innerHTML+=`<div class="assigned-routine-item"><span>${r.data().name}</span><button style="color:red;background:0;border:0" onclick="unassignRoutine('${r.id}')">‚ùå</button></div>`; });
            } catch(e) { document.getElementById('coach-assigned-list').innerHTML='Error cargando asignadas.'; }

            try {
                const hList=document.getElementById('coach-history-list'); hList.innerHTML='Cargando...';
                const qH=query(collection(db,"workouts"),where("uid","==",uid),orderBy("date","desc"),limit(10));
                const sH=await getDocs(qH); hList.innerHTML='';
                sH.forEach(w=>{
                    const d=w.data(); const dt=new Date(d.date.seconds*1000).toLocaleDateString();
                    const col=d.rpe==='Fallo'?'red':(d.rpe==='Duro'?'orange':'green');
                    const noteIcon = (d.note && d.note.trim().length > 0) ? `<span class="note-icon" title="${d.note}" onclick="alert('${d.note}')">üìù</span>` : '';
                    hList.innerHTML+=`<div class="history-row"><div>${dt}</div><div>${d.routine} ${noteIcon}</div><div class="badge ${col}">${d.rpe||'-'}</div></div>`;
                });

                if(coachChart) coachChart.destroy();
                const ctx = document.getElementById('coachWeightChart'); const wData = u.weightHistory || [];
                coachChart = new Chart(ctx, { type:'line', data:{ labels:wData.map((_,i)=>i+1), datasets:[{label:'Kg', data:wData, borderColor:'#ff3333', fill:false}] }, options:{plugins:{legend:{display:false}}, scales:{x:{display:false},y:{grid:{color:'#333'}}}}});
            } catch(e) { console.error("Error history/chart", e); }

            if(!u.approved && confirm("¬øAprobar acceso a este atleta?")) { await updateDoc(doc(db,"users",uid),{approved:true}); loadAdminUsers(); }
        }

        window.renderCoachRoutines=(list)=>{ const s=document.getElementById('coach-routine-select'); s.innerHTML=''; list.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.innerText=r.name;s.appendChild(o)}); }
        window.filterCoachRoutines=(v)=>{ renderCoachRoutines(allRoutinesCache.filter(r=>r.name.toLowerCase().includes(v.toLowerCase()))); }
        
        window.switchCoachPose=(p)=>{
            coachCurrentPose=p; document.getElementById('coach-tab-front').classList.toggle('active',p==='front'); document.getElementById('coach-tab-back').classList.toggle('active',p==='back');
            updateCoachPhotoDisplay(p);
        }
        function updateCoachPhotoDisplay(p){
            const u=selectedUserObj; const pre=p==='front'?'':'_back';
            const b=u[`photoBefore${pre}`]; const a=u[`photoAfter${pre}`]; const db=u[`dateBefore${pre}`]||'-'; const da=u[`dateAfter${pre}`]||'-';
            document.getElementById('coach-photos-container').innerHTML=`<div class="coach-photo-box">${b?`<img src="${b}"><div class="photo-date-label">ANTES (${db})</div>`:'Sin Foto'}</div><div class="coach-photo-box">${a?`<img src="${a}"><div class="photo-date-label">AHORA (${da})</div>`:'Sin Foto'}</div>`;
        }

        window.assignRoutine=async()=>{ const rid=document.getElementById('coach-routine-select').value; if(!rid)return; await updateDoc(doc(db,"routines",rid),{assignedTo:arrayUnion(selectedUserCoach)}); alert("Asignada"); const u=await getDoc(doc(db,"users",selectedUserCoach)); openCoachModal(selectedUserCoach,u.data()); };
        window.unassignRoutine=async(rid)=>{ if(confirm("Quitar?")){ await updateDoc(doc(db,"routines",rid),{assignedTo:arrayRemove(selectedUserCoach)}); const u=await getDoc(doc(db,"users",selectedUserCoach)); openCoachModal(selectedUserCoach,u.data()); } };
        window.goToCreateRoutine=()=>{ document.getElementById('modal-coach').classList.remove('active'); openEditor(); };
        window.deleteUser=async()=>{ if(confirm("¬øELIMINAR?") && confirm("¬øSEGURO?")){ await deleteDoc(doc(db,"users",selectedUserCoach)); document.getElementById('modal-coach').classList.remove('active'); loadAdminUsers(); } };

        document.getElementById('btn-login').onclick=()=>signInWithEmailAndPassword(auth,document.getElementById('login-email').value,document.getElementById('login-pass').value).catch(e=>alert(e.message));
        document.getElementById('btn-register').onclick=async()=>{
            if(document.getElementById('reg-code').value!==CODE)return alert("C√≥digo incorrecto");
            try{ const c=await createUserWithEmailAndPassword(auth,document.getElementById('reg-email').value,document.getElementById('reg-pass').value);
            await setDoc(doc(db,"users",c.user.uid),{name:document.getElementById('reg-name').value,email:document.getElementById('reg-email').value,approved:document.getElementById('reg-email').value===ADMIN,age:parseInt(document.getElementById('reg-age').value),height:parseInt(document.getElementById('reg-height').value), weightHistory: []});
            }catch(e){alert(e.message)}
        };
    </script>
</body>
</html>
