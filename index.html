<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fit Data">
    <meta name="theme-color" content="#0a0a0a">
    <title>Fit Data by Toni</title>
    
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* --- ESTILOS ORIGINALES DE TU 'INDEX REAL.HTML' --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0a0a;       /* Negro Puro */
            --bg-secondary: #1a1a1a;     /* Gris Oscuro */
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #ff4444;           /* Rojo Corporativo */
            --accent-dark: #cc0000;
            --success: #22dd88;
            --warning: #ffaa00;
            --gold: #ffd700;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 20px;
        }

        /* Utilidades */
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .container-sm { max-width: 500px; margin: 0 auto; padding: 1rem; }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Navbar */
        .navbar {
            background-color: var(--bg-secondary);
            padding: 1rem;
            border-bottom: 2px solid var(--accent);
            position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
        }
        .navbar-brand { font-size: 1.5rem; font-weight: 800; color: var(--accent); letter-spacing: 1px; }
        .nav-right button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; }

        /* Botones */
        button {
            background-color: var(--accent);
            color: var(--text-primary);
            border: none; padding: 0.8rem 1.5rem; border-radius: 6px;
            cursor: pointer; font-weight: 600; font-size: 1rem;
            transition: transform 0.1s; width: 100%;
        }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: transparent; border: 1px solid var(--accent); color: var(--accent); }
        button.success { background-color: var(--success); color: #000; }

        /* Formularios */
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select {
            width: 100%; padding: 0.8rem;
            border: 1px solid #333; background-color: #222;
            color: var(--text-primary); border-radius: 6px; font-size: 1rem;
        }
        .form-group input:focus { outline: none; border-color: var(--accent); }

        /* Cards */
        .card {
            background-color: var(--bg-secondary);
            padding: 1.5rem; border-radius: 8px;
            margin-bottom: 1rem; border-left: 4px solid var(--accent);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .card h3 { color: var(--accent); margin-bottom: 0.5rem; }

        /* --- NUEVO: Estilo de Ejercicio con Imagen Generada --- */
        .exercise-item {
            display: flex; align-items: center; gap: 15px;
            background: var(--bg-primary); padding: 10px;
            border-radius: 8px; margin-bottom: 8px;
            border: 1px solid #333; cursor: pointer;
        }
        .exercise-item.selected { border-color: var(--accent); background: rgba(255, 68, 68, 0.1); }
        
        .exercise-icon { 
            width: 50px; height: 50px; 
            border-radius: 8px; 
            background: white; /* Fondo blanco */
            border: 2px solid var(--accent); /* Borde rojo */
            object-fit: contain; flex-shrink: 0; padding: 2px;
        }

        /* --- MODO ENTRENAMIENTO --- */
        .set-row {
            display: grid; grid-template-columns: 40px 1fr 1fr 60px 40px;
            gap: 8px; align-items: center; margin-bottom: 8px;
            background: #252525; padding: 8px; border-radius: 6px;
        }
        .set-row.completed { border: 1px solid var(--success); background: rgba(34, 221, 136, 0.1); }
        .check-circle { 
            width: 30px; height: 30px; border-radius: 50%; 
            border: 2px solid #666; display:flex; align-items:center; justify-content:center;
            cursor: pointer;
        }
        .check-circle.checked { background: var(--success); border-color: var(--success); color: black; font-weight: bold; }
        .check-circle.checked::after { content: '‚úì'; }

        /* Modales */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--accent); }

        /* Admin */
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #222; margin-bottom: 5px; border-radius: 6px; }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active" style="text-align: center; padding-top: 40vh;">
        <h2 style="color: var(--accent);">FIT DATA</h2>
        <p style="color: #666;">Cargando...</p>
    </div>

    <div id="login-screen" class="screen">
        <div class="container-sm" style="margin-top: 50px;">
            <div class="card" style="text-align: center;">
                <h1 style="color: var(--accent); font-size: 2.5rem; letter-spacing: 2px;">FIT DATA</h1>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">Entrenamiento Inteligente</p>
                
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <input type="email" id="login-email" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="login-pass" placeholder="Contrase√±a" required>
                    </div>
                    <button type="submit">ENTRAR</button>
                </form>
                
                <p style="margin-top: 20px; color: #888; font-size: 0.9rem;" onclick="showRegister()">
                    ¬øNo tienes cuenta? <span style="color: var(--accent); cursor: pointer;">Reg√≠strate</span>
                </p>
            </div>
        </div>
    </div>

    <div id="register-screen" class="screen">
        <div class="container-sm">
            <div class="card">
                <h2 style="text-align: center; color: var(--accent);">Crear Cuenta</h2>
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" id="reg-name" placeholder="Ej: Juan P√©rez" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="reg-email" placeholder="tu@email.com" required>
                    </div>
                    <div class="form-group">
                        <label style="color: var(--accent);">C√ìDIGO DE ACCESO</label>
                        <input type="text" id="reg-code" placeholder="C√≥digo secreto" style="text-align: center; border-color: var(--accent);" required>
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a</label>
                        <input type="password" id="reg-pass" placeholder="M√≠nimo 6 caracteres" required>
                    </div>
                    <button type="submit">SOLICITAR ACCESO</button>
                    <button type="button" class="secondary" style="margin-top: 10px;" onclick="showLogin()">Volver</button>
                </form>
            </div>
        </div>
    </div>

    <div id="dashboard-screen" class="screen">
        <nav class="navbar">
            <div class="navbar-brand">FIT DATA <small style="color: white; font-size: 0.6em;">by Toni</small></div>
            <div class="nav-right">
                <span id="user-name-display" style="font-size: 0.9rem; margin-right: 10px; color: #888;"></span>
                <button onclick="logout()" style="width: auto; padding: 5px 10px; font-size: 0.8rem;">Salir</button>
            </div>
        </nav>

        <div class="container">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="openCreateModal()">+ Nueva Rutina</button>
                <button id="admin-btn" class="secondary hidden" onclick="showAdmin()">Panel Admin</button>
            </div>

            <h3 style="border-bottom: 1px solid var(--accent); padding-bottom: 10px; margin-bottom: 15px; color: var(--accent);">Mis Rutinas</h3>
            <div id="routines-list"></div>
        </div>
    </div>

    <div id="workout-screen" class="screen">
        <nav class="navbar">
            <button onclick="goToDashboard()" style="width: auto; background: none; color: white; font-size: 1.5rem; padding: 0;">‚Üê</button>
            <div id="workout-title" style="font-weight: bold; color: var(--accent);">Rutina</div>
            <div id="workout-timer" style="font-family: monospace; border: 1px solid var(--accent); padding: 2px 6px; border-radius: 4px; color: var(--accent);">00:00</div>
        </nav>
        <div class="container" id="workout-container"></div>
        <div class="container" style="padding-top: 0;">
            <button class="success" onclick="finishWorkout()">Finalizar Entrenamiento</button>
        </div>
    </div>

    <div id="admin-screen" class="screen">
        <nav class="navbar">
            <button onclick="goToDashboard()" style="width: auto; background: none; color: white;">‚Üê Volver</button>
            <div>Gesti√≥n Usuarios</div>
            <div></div>
        </nav>
        <div class="container">
            <div class="card">
                <h3>Pendientes de Aprobaci√≥n</h3>
                <div id="pending-list"></div>
            </div>
            <h3 style="margin-top: 20px; color: var(--accent);">Todos los Usuarios</h3>
            <div id="all-users-list"></div>
        </div>
    </div>

    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h3>Dise√±ar Rutina</h3>
            <div class="form-group">
                <input type="text" id="new-routine-name" placeholder="Nombre de la rutina (Ej: Pecho)">
            </div>
            
            <div class="form-group">
                <input type="text" id="search-ex" placeholder="üîç Buscar ejercicio..." onkeyup="renderExerciseSelector()">
            </div>
            
            <div id="exercise-selector" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="saveRoutine()">Guardar</button>
                <button class="secondary" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN FIREBASE (Tus claves reales) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCmM0gViU3itZ4HIZZVTEm7OaV0iBtsiGs",
            authDomain: "fitdata-7a86b.firebaseapp.com",
            projectId: "fitdata-7a86b",
            storageBucket: "fitdata-7a86b.firebasestorage.app",
            messagingSenderId: "949628013924",
            appId: "1:949628013924:web:86278ae2c2bafb384d7e71"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GENERADOR DE IM√ÅGENES SVG (ESTILO "PECHO.JPG") ---
        function getMuscleSvg(muscleName) {
            const safeId = muscleName.toLowerCase().replace(/[^a-z0-9]/g, '');
            // SVG: Fondo Blanco, Borde Rojo Grueso (#FF0000), Silueta Negra, M√∫sculo Rojo
            return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
              <rect x="5" y="5" width="90" height="90" rx="15" fill="#ffffff" stroke="#FF0000" stroke-width="6"/>
              <path d="M50,18 C56,18 60,23 60,29 C60,35 56,39 50,39 C44,39 40,35 40,29 C40,23 44,18 50,18 Z M32,45 C28,50 22,65 22,85 L32,85 L38,60 L38,85 L62,85 L62,60 L68,85 L78,85 C78,65 72,50 68,45 C64,40 36,40 32,45 Z" fill="#000000"/>
              ${getHighlightPath(muscleName)}
            </svg>`);
        }

        function getHighlightPath(muscle) {
            const m = muscle.toLowerCase();
            let p = '';
            if (m.includes('pierna') || m.includes('glute')) p = 'M22,85 L32,85 L38,60 L32,45 C28,50 22,65 22,85 Z M68,85 L78,85 C78,65 72,50 68,45 L62,60 L62,85 Z';
            else if (m.includes('pecho')) p = 'M36,44 C36,40 64,40 64,44 C64,52 60,56 52,56 L48,56 C40,56 36,52 36,44 Z';
            else if (m.includes('espalda')) p = 'M32,45 L38,60 L62,60 L68,45 C64,38 36,38 32,45 Z';
            else if (m.includes('hombro')) p = 'M26,48 L32,45 L38,48 L36,55 Z M74,48 L68,45 L62,48 L64,55 Z';
            else if (m.includes('biceps') || m.includes('b√≠ceps')) p = 'M26,56 L32,50 L36,60 Z M74,56 L68,50 L64,60 Z';
            else if (m.includes('triceps') || m.includes('tr√≠ceps')) p = 'M24,52 L28,48 L30,58 Z M76,52 L72,48 L70,58 Z';
            else if (m.includes('abs')) p = 'M42,58 L58,58 L56,78 L44,78 Z';
            return p ? `<path d="${p}" fill="#FF0000" stroke="none"/>` : '';
        }

        // --- BASE DE DATOS COMPLETA (82 EJERCICIOS) CON IM√ÅGENES GENERADAS ---
        const rawExercises = [
            { id: 1, name: 'Sentadilla con Barra', muscle: 'Piernas' },
            { id: 2, name: 'Sentadilla Jaca', muscle: 'Piernas' },
            { id: 3, name: 'Sentadilla con Cintur√≥n', muscle: 'Piernas' },
            { id: 4, name: 'Prensa de Piernas', muscle: 'Piernas' },
            { id: 5, name: 'Extensi√≥n de Cu√°driceps', muscle: 'Piernas' },
            { id: 6, name: 'Estocadas con Mancuernas', muscle: 'Piernas' },
            { id: 7, name: 'Curl de Pierna Tumbado', muscle: 'Piernas' },
            { id: 8, name: 'Curl de Pierna Sentado', muscle: 'Piernas' },
            { id: 9, name: 'Prensa Horizontal', muscle: 'Piernas' },
            { id: 10, name: 'Prensa de piernas 45¬∞', muscle: 'Piernas' },
            { id: 11, name: 'Elevaci√≥n de Talones Sentado', muscle: 'Piernas' },
            { id: 12, name: 'Elevaci√≥n de Talones de Pie', muscle: 'Piernas' },
            { id: 13, name: 'Elevaci√≥n de Talones en M√°quina', muscle: 'Piernas' },
            { id: 14, name: 'Elevaci√≥n de Cadera', muscle: 'Piernas' },
            { id: 15, name: 'Sentadilla B√∫lgara', muscle: 'Piernas' },
            { id: 16, name: 'Patada de Gl√∫teo en Polea', muscle: 'Piernas' },
            { id: 17, name: 'Abducci√≥n de Cadera en M√°quina', muscle: 'Piernas' },
            { id: 18, name: 'Prensa de Gl√∫teos', muscle: 'Piernas' },
            { id: 19, name: 'Peso Muerto', muscle: 'Espalda' },
            { id: 20, name: 'Peso Muerto Rumano', muscle: 'Piernas' },
            { id: 21, name: 'Peso Muerto Sumo', muscle: 'Espalda' },
            { id: 22, name: 'Remo con Barra', muscle: 'Espalda' },
            { id: 23, name: 'Remo con Mancuernas', muscle: 'Espalda' },
            { id: 24, name: 'Jal√≥n Lateral', muscle: 'Espalda' },
            { id: 25, name: 'Jal√≥n Lateral Cerrado', muscle: 'Espalda' },
            { id: 26, name: 'Remo en M√°quina', muscle: 'Espalda' },
            { id: 27, name: 'Remo en Polea Baja', muscle: 'Espalda' },
            { id: 28, name: 'Dominadas', muscle: 'Espalda' },
            { id: 29, name: 'Dominadas Asistidas', muscle: 'Espalda' },
            { id: 30, name: 'Remo Invertido', muscle: 'Espalda' },
            { id: 31, name: 'Remo T', muscle: 'Espalda' },
            { id: 32, name: 'Hiperextensi√≥n', muscle: 'Espalda' },
            { id: 33, name: 'Buenos D√≠as', muscle: 'Espalda' },
            { id: 34, name: 'Press de Banca', muscle: 'Pecho' },
            { id: 35, name: 'Press Inclinado con Mancuernas', muscle: 'Pecho' },
            { id: 36, name: 'Aperturas con Mancuernas', muscle: 'Pecho' },
            { id: 37, name: 'Cruces en Polea', muscle: 'Pecho' },
            { id: 38, name: 'Prensa de Pecho en M√°quina', muscle: 'Pecho' },
            { id: 39, name: 'Prensa de Pecho Declinado', muscle: 'Pecho' },
            { id: 40, name: 'Fondos en Paralelas', muscle: 'Pecho' },
            { id: 41, name: 'Encogimiento de Hombros', muscle: 'Hombros' },
            { id: 42, name: 'Encogimiento con Mancuernas', muscle: 'Hombros' },
            { id: 43, name: 'Press Militar', muscle: 'Hombros' },
            { id: 44, name: 'Press de Hombros con Mancuernas', muscle: 'Hombros' },
            { id: 45, name: 'Press de Hombros en M√°quina', muscle: 'Hombros' },
            { id: 46, name: 'Elevaci√≥n Lateral', muscle: 'Hombros' },
            { id: 47, name: 'Elevaci√≥n Frontal', muscle: 'Hombros' },
            { id: 48, name: 'P√°jaros Inversos', muscle: 'Hombros' },
            { id: 49, name: 'Elevaci√≥n Lateral en Polea', muscle: 'Hombros' },
            { id: 50, name: 'Press Arnold', muscle: 'Hombros' },
            { id: 51, name: 'Curl de Barra', muscle: 'Biceps' },
            { id: 52, name: 'Curl de Mancuernas', muscle: 'Biceps' },
            { id: 53, name: 'Curl en Polea', muscle: 'Biceps' },
            { id: 54, name: 'Curl Martillo', muscle: 'Biceps' },
            { id: 55, name: 'Curl Concentrado', muscle: 'Biceps' },
            { id: 56, name: 'Extensi√≥n de Tr√≠ceps en Polea', muscle: 'Triceps' },
            { id: 57, name: 'Extensi√≥n Francesa', muscle: 'Triceps' },
            { id: 58, name: 'Extensiones Acostadas', muscle: 'Triceps' },
            { id: 59, name: 'Fondos en Paralelas', muscle: 'Triceps' },
            { id: 60, name: 'Extensi√≥n Unilateral Tr√≠ceps', muscle: 'Triceps' },
            { id: 61, name: 'Abdominales con Rueda', muscle: 'Abs' },
            { id: 62, name: 'Crunch en Polea', muscle: 'Abs' },
            { id: 63, name: 'Elevaciones de Pierna Colgadas', muscle: 'Abs' },
            { id: 64, name: 'Abdominales en Banco', muscle: 'Abs' },
            { id: 65, name: 'Crunch en M√°quina', muscle: 'Abs' },
            { id: 66, name: 'Levantamiento de Rodillas Colgado', muscle: 'Abs' },
            { id: 67, name: 'Aperturas de Pecho', muscle: 'Pecho' },
            { id: 68, name: 'Press Inclinado', muscle: 'Pecho' },
            { id: 69, name: 'Press Plano', muscle: 'Pecho' },
            { id: 70, name: 'Prensa Lateral Iso', muscle: 'Pecho' },
            { id: 71, name: 'Prensa de Pecho', muscle: 'Pecho' },
            { id: 72, name: 'Triceps Polea', muscle: 'Triceps' },
            { id: 73, name: 'Triceps Barra', muscle: 'Triceps' },
            { id: 74, name: 'Remo Hammer', muscle: 'Espalda' },
            { id: 75, name: 'Jal√≥n Agarre Cerrado', muscle: 'Espalda' },
            { id: 76, name: 'Jal√≥n Agarre Abierto', muscle: 'Espalda' },
            { id: 77, name: 'Remo alto', muscle: 'Espalda' },
            { id: 78, name: 'Press de Hombros', muscle: 'Hombros' },
            { id: 79, name: 'Face Pull', muscle: 'Hombros' },
            { id: 80, name: 'Curl Predicador', muscle: 'Biceps' },
            { id: 81, name: 'Curl Concentrado', muscle: 'Biceps' },
            { id: 82, name: 'Prensa 45¬∞', muscle: 'Piernas' }
        ];
        
        // Mapeo final: A√±adimos la imagen SVG generada a cada ejercicio
        const exercisesDB = rawExercises.map(ex => ({
            ...ex,
            image: getMuscleSvg(ex.muscle)
        }));

        // --- 4. L√ìGICA DE LA APLICACI√ìN ---
        const ACCESS_CODE = "fityhab";
        let currentUser = null;
        let userData = null;
        let selectedExercises = [];
        let workoutTimer = null;
        let startTime = null;

        // Listener Auth
        auth.onAuthStateChanged(async (user) => {
            hideAllScreens();
            if (user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    userData = doc.data();
                    if (userData.approved || userData.role === 'admin') {
                        currentUser = user;
                        initDashboard();
                    } else {
                        alert("Cuenta creada. Espera a que Toni te apruebe.");
                        auth.signOut();
                        showScreen('login-screen');
                    }
                } else {
                    // Caso raro: usuario auth pero no db
                    auth.signOut();
                    showScreen('login-screen');
                }
            } else {
                showScreen('login-screen');
            }
            document.getElementById('loading-screen').classList.remove('active');
        });

        // Navegaci√≥n
        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        }
        function showScreen(id) {
            hideAllScreens();
            document.getElementById(id).classList.add('active');
        }
        function showRegister() { showScreen('register-screen'); }
        function showLogin() { showScreen('login-screen'); }
        function logout() { auth.signOut(); }

        // Login & Registro
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try { await auth.signInWithEmailAndPassword(email, pass); }
            catch(err) { alert("Error: " + err.message); }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const code = document.getElementById('reg-code').value;

            if (code !== ACCESS_CODE) return alert("‚õî C√≥digo de acceso incorrecto");

            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection('users').doc(cred.user.uid).set({
                    username: name,
                    email: email,
                    role: 'user',
                    approved: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("‚úÖ Solicitud enviada correctamente. Espera aprobaci√≥n.");
                showLogin();
            } catch(err) { alert(err.message); }
        }

        // Dashboard
        function initDashboard() {
            showScreen('dashboard-screen');
            document.getElementById('user-name-display').innerText = `Hola, ${userData.username}`;
            if (userData.role === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
            loadRoutines();
        }

        async function loadRoutines() {
            const list = document.getElementById('routines-list');
            list.innerHTML = '<p style="color:#888;">Cargando...</p>';
            
            const snap = await db.collection('users').doc(currentUser.uid).collection('routines').orderBy('createdAt', 'desc').get();
            list.innerHTML = '';
            
            if (snap.empty) { list.innerHTML = '<p style="color:#888;">No tienes rutinas asignadas.</p>'; return; }

            snap.forEach(doc => {
                const r = doc.data();
                const div = document.createElement('div');
                div.className = 'card';
                // Iconos preview (Max 5)
                const icons = r.exercises.slice(0, 5).map(ex => `<img src="${ex.image}" style="width:30px; height:30px; background:white; border-radius:4px; margin-right:5px; border:1px solid #444;">`).join('');

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>${r.name}</h3>
                        <button onclick="deleteRoutine('${doc.id}')" style="background:none; border:none; color:#666; width:auto; padding:5px;">üóëÔ∏è</button>
                    </div>
                    <div style="margin: 10px 0;">${icons}</div>
                    <button onclick="startWorkout('${doc.id}')">ENTRENAR</button>
                `;
                list.appendChild(div);
            });
        }

        // Crear Rutina
        function openCreateModal() {
            selectedExercises = [];
            document.getElementById('new-routine-name').value = '';
            renderExerciseSelector();
            document.getElementById('create-modal').classList.add('active');
        }
        function closeModal() { document.getElementById('create-modal').classList.remove('active'); }

        function renderExerciseSelector() {
            const filter = document.getElementById('search-ex').value.toLowerCase();
            const container = document.getElementById('exercise-selector');
            container.innerHTML = '';
            
            exercisesDB.filter(ex => ex.name.toLowerCase().includes(filter)).forEach(ex => {
                const div = document.createElement('div');
                div.className = `exercise-item ${selectedExercises.includes(ex.id) ? 'selected' : ''}`;
                div.innerHTML = `
                    <img src="${ex.image}" class="exercise-icon">
                    <div>
                        <div style="font-weight:bold; color:white;">${ex.name}</div>
                        <div style="font-size:0.8rem; color:#888;">${ex.muscle}</div>
                    </div>
                `;
                div.onclick = () => {
                    if (selectedExercises.includes(ex.id)) selectedExercises = selectedExercises.filter(id => id !== ex.id);
                    else selectedExercises.push(ex.id);
                    renderExerciseSelector();
                };
                container.appendChild(div);
            });
        }

        async function saveRoutine() {
            const name = document.getElementById('new-routine-name').value;
            if (!name || selectedExercises.length === 0) return alert("Falta nombre o ejercicios");
            
            const routineExercises = selectedExercises.map(id => exercisesDB.find(e => e.id === id));
            await db.collection('users').doc(currentUser.uid).collection('routines').add({
                name, exercises: routineExercises, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal();
            loadRoutines();
        }

        async function deleteRoutine(id) {
            if (confirm("¬øBorrar esta rutina?")) {
                await db.collection('users').doc(currentUser.uid).collection('routines').doc(id).delete();
                loadRoutines();
            }
        }

        // Entrenamiento
        async function startWorkout(id) {
            const doc = await db.collection('users').doc(currentUser.uid).collection('routines').doc(id).get();
            const routineData = doc.data();
            
            showScreen('workout-screen');
            document.getElementById('workout-title').innerText = routineData.name;
            const container = document.getElementById('workout-container');
            container.innerHTML = '';

            // Timer
            startTime = new Date();
            if (workoutTimer) clearInterval(workoutTimer);
            workoutTimer = setInterval(() => {
                const diff = Math.floor((new Date() - startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('workout-timer').innerText = `${m}:${s}`;
            }, 1000);

            routineData.exercises.forEach((ex, idx) => {
                let rows = '';
                // 3 Series por defecto
                for(let i=1; i<=3; i++) {
                    rows += `
                    <div class="set-row">
                        <div style="text-align:center; color:#888;">#${i}</div>
                        <input type="number" placeholder="Reps" style="text-align:center; padding:5px; background:#333; border:none; color:white; border-radius:4px;">
                        <input type="number" placeholder="Kg" style="text-align:center; padding:5px; background:#333; border:none; color:white; border-radius:4px;">
                        <div style="font-size:0.8rem; color:#666; text-align:center;">--</div>
                        <div class="check-circle" onclick="this.classList.toggle('checked'); this.parentElement.classList.toggle('completed')"></div>
                    </div>`;
                }
                
                container.innerHTML += `
                    <div class="card">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;">
                            <img src="${ex.image}" class="exercise-icon">
                            <h4 style="color:white; margin:0;">${ex.name}</h4>
                        </div>
                        ${rows}
                    </div>
                `;
            });
        }

        function goToDashboard() { showScreen('dashboard-screen'); }
        function finishWorkout() {
            if (confirm("¬øFinalizar entrenamiento?")) {
                alert("Entrenamiento guardado üí™");
                goToDashboard();
            }
        }

        // Admin
        function showAdmin() { showScreen('admin-screen'); loadAdminUsers(); }

        async function loadAdminUsers() {
            const pendingDiv = document.getElementById('pending-list');
            const allDiv = document.getElementById('all-users-list');
            pendingDiv.innerHTML = '<p style="color:#888;">Cargando...</p>';
            allDiv.innerHTML = '';

            const snap = await db.collection('users').orderBy('createdAt', 'desc').get();
            let pendingHTML = '';
            let allHTML = '';

            snap.forEach(doc => {
                const u = doc.data();
                const row = `
                    <div class="user-row">
                        <div>
                            <strong style="color:white; display:block;">${u.username}</strong>
                            <small style="color:#888;">${u.email}</small>
                        </div>
                        <div>
                            ${!u.approved ? `<button onclick="approveUser('${doc.id}')" class="success" style="width:auto; padding:5px 10px; font-size:0.8rem;">Aprobar</button>` : '<span style="color:var(--success); font-size:0.8rem; margin-right:10px;">Activo</span>'}
                            <button onclick="deleteUser('${doc.id}')" style="background:none; border:none; color:#666; cursor:pointer;">‚ùå</button>
                        </div>
                    </div>
                `;
                if (!u.approved && u.role !== 'admin') pendingHTML += row;
                allHTML += row;
            });

            pendingDiv.innerHTML = pendingHTML || '<p style="color:#666;">No hay usuarios pendientes.</p>';
            allDiv.innerHTML = allHTML;
        }

        async function approveUser(id) {
            await db.collection('users').doc(id).update({ approved: true });
            loadAdminUsers();
        }
        async function deleteUser(id) {
            if (confirm("¬øEliminar usuario permanentemente?")) {
                await db.collection('users').doc(id).delete();
                loadAdminUsers();
            }
        }

        // Bloqueo de pantalla (WakeLock)
        let wakeLock = null;
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            }
        }
    </script>
</body>
</html>